<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Lifewood AI</title>
    <link rel="icon" href="icon.png" type="image/png">
   <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Lora:wght@400;500;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    :root {
        --brand-green: #0a5441;
        --brand-saffron: #FFB347;
        --brand-green-light: #e6f0ed; 
        --bg-color: #f7f7f7;
        --card-bg-color: #ffffff;
        --sidebar-bg: #ffffff;
        --primary-blue: var(--brand-green);
        --primary-blue-light: var(--brand-green-light);
        --text-dark: #333333;
        --text-light: #6b7280;
        --border-color: #e0e0e0;
        --green: #10b981;
        --red: #ef4444;
        --orange: var(--brand-saffron);
        --chart-grid-color: rgba(0, 0, 0, 0.08);
        --chart-label-color: #6b7280;
    }
    
    body.dark-mode {
        --bg-color: #111827;
        --card-bg-color: #1f2937;
        --sidebar-bg: #1f2937;
        --primary-blue-light: #113c30;
        --text-dark: #f4f4f4;
        --text-light: #9ca3af;
        --border-color: #374151;
        --chart-grid-color: rgba(255, 255, 255, 0.1);
        --chart-label-color: #9ca3af;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
        font-family: 'Manrope', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-dark);
        display: flex;
        transition: background-color 0.3s, color 0.3s;
    }
    
    body.compact-mode .nav-item { padding-top: 10px; padding-bottom: 10px; }
    body.compact-mode .widget-card { padding: 16px; }
    body.compact-mode .application-table th, body.compact-mode .application-table td { padding: 12px; }
    body.compact-mode .employee-card { padding: 16px; }
    body.compact-mode .employee-card img { width: 80px; height: 80px; }
    
    #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
    .toast { padding: 12px 20px; background-color: #2d3748; color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; opacity: 0; transform: translateY(20px); animation: toast-in 0.5s forwards; }
    .toast.success { background-color: var(--green); }
    .toast.error { background-color: var(--red); }
    .toast i { font-size: 20px; }
    @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
    
    .sidebar { width: 260px; background-color: var(--sidebar-bg); padding: 24px; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); height: 100vh; position: fixed; z-index: 100; transition: background-color 0.3s, border-color 0.3s; }

    .sidebar .logo {
        display: block;
        margin-bottom: 40px;
    }
    .sidebar .logo .logo-image {
        height: 50px;
        width: auto;
    }
    
    .sidebar .nav-item { display: flex; align-items: center; padding: 14px 18px; border-radius: 8px; text-decoration: none; color: var(--text-light); font-weight: 600; margin-bottom: 8px; transition: all 0.2s ease; cursor: pointer; }
    .sidebar .nav-item i { font-size: 22px; margin-right: 16px; }
    .sidebar .nav-item.active, .sidebar .nav-item:hover { background-color: var(--primary-blue-light); color: var(--primary-blue); }
    .sidebar .logout-btn { margin-top: auto; background: none; border: none; width: 100%; }
    
    .main-content { flex-grow: 1; margin-left: 260px; padding: 24px 32px; }
    .main-page { display: none; }
    .main-page.active { display: block; }
    
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    
    .page-header .greeting h1 {
        font-family: 'Lora', serif;
        font-size: 28px;
        font-weight: 700;
        color: var(--brand-green);
    }
    
    .page-header .greeting p { color: var(--text-light); }
    .search-bar { display: flex; align-items: center; background-color: var(--card-bg-color); border: 1px solid var(--border-color); padding: 8px 16px; border-radius: 8px; }
    .search-bar i { color: var(--text-light); font-size: 20px; }
    .search-bar input { border: none; outline: none; background: none; margin-left: 8px; font-family: 'Manrope', sans-serif; font-size: 14px; color: var(--text-dark); }
    
    .widget-card { background-color: var(--card-bg-color); padding: 24px; border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.2s ease; }
    
    h2.section-title {
        font-family: 'Lora', serif;
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 24px;
        color: var(--brand-green);
    }
    
    .dashboard-widgets { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 24px; margin-bottom: 32px; }
    .widget-card .icon-wrapper { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    .widget-card .icon-wrapper i { font-size: 24px; }
    .widget-card h3 { color: var(--text-light); font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .widget-card .count { font-size: 36px; font-weight: 800; }
    
    .application-section { background-color: var(--card-bg-color); border-radius: 12px; padding: 24px; border: 1px solid var(--border-color); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .tabs { display: flex; border-bottom: 1px solid var(--border-color); }
    .tab-button { padding: 12px 20px; cursor: pointer; background: none; border: none; font-family: 'Manrope', sans-serif; font-size: 14px; font-weight: 600; color: var(--text-light); position: relative; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s ease; }
    .tab-button.active, .tab-button:hover { color: var(--primary-blue); border-bottom-color: var(--primary-blue); }
    .tab-content { display: none; margin-top: 24px; }
    .tab-content.active { display: block; }
    
    .application-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .application-table th, .application-table td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .application-table th { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-light); font-weight: 600; }
    .application-table a { color: var(--primary-blue); font-weight: 600; text-decoration: none; }
    .details-cell { white-space: normal; }
    .action-btn { padding: 8px 12px; border-radius: 6px; cursor: pointer; border: none; font-weight: 700; font-size: 12px; margin-right: 5px; }
    .accept-btn { background-color: #d1fae5; color: #065f46; }
    .reject-btn { background-color: #fee2e2; color: #b91c1c; }
    .no-apps-message { text-align: center; padding: 50px; color: var(--text-light); font-size: 16px; }
    
    .employee-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 24px; }
    .employee-card { text-align: center; padding: 24px; }
    .employee-card img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin-bottom: 16px; border: 4px solid var(--card-bg-color); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    .employee-card h4 { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
    .employee-card p { color: var(--text-light); font-size: 14px; margin-bottom: 12px; }
    .employee-card .status { background-color: var(--green); color: white; font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 12px; display: inline-block; }
    
    /* NEW STYLE FOR ROLE TITLES */
    .role-title {
        font-family: 'Lora', serif;
        font-size: 20px;
        font-weight: 700;
        color: var(--brand-green);
        margin-top: 32px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    #employeeGrid .role-title:first-of-type {
        margin-top: 0;
    }

    .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 20px 0; border-bottom: 1px solid var(--border-color); }
    .setting-item:last-child { border-bottom: none; }
    .setting-item .label h4 { font-size: 16px; font-weight: 600; }
    .setting-item .label p { font-size: 14px; color: var(--text-light); }
    
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--primary-blue); }
    input:checked + .slider:before { transform: translateX(22px); }
    input:disabled + .slider { cursor: not-allowed; background-color: #e0e0e0; }
</style>
</head>
<body>

    <div id="toast-container"></div>
    <aside class="sidebar">
       <a href="index.html" class="logo">
    <img src="logo.png" alt="Lifewood Logo" class="logo-image">
</a>
        <a class="nav-item active" data-page="dashboard"><i class='bx bxs-dashboard'></i><span>Dashboard</span></a>
        <a class="nav-item" data-page="employees"><i class='bx bxs-user-detail'></i><span>Employees</span></a>
        
        <a class="nav-item" data-page="settings"><i class='bx bxs-cog'></i><span>Settings</span></a>
        <button id="logoutBtn" class="nav-item logout-btn"><i class='bx bx-log-out'></i><span>Logout</span></button>
    </aside>

    <main class="main-content">
        <!-- All pages are now complete -->
        <div id="dashboard-page" class="main-page active">
            <header class="page-header"><div class="greeting"><h1>Hello, Admin</h1><p id="currentDate"></p></div></header>
            <section class="dashboard-widgets">
                <div class="widget-card pending"><div class="icon-wrapper"><i class='bx bx-time-five'></i></div><h3>Pending Applications</h3><p class="count" id="pendingCount">0</p></div>
                <div class="widget-card employees"><div class="icon-wrapper"><i class='bx bx-user-check'></i></div><h3>Total Employees & Interns</h3><p class="count" id="acceptedCount">0</p></div>
                <div class="widget-card rejected"><div class="icon-wrapper"><i class='bx bx-user-x'></i></div><h3>Rejected Applicants</h3><p class="count" id="rejectedCount">0</p></div>
            </section>
            <section class="application-section">
                <div class="section-header"><h2>Application Management</h2><div class="tabs"><button class="tab-button active" data-tab="recent">Recent Pending</button><button class="tab-button" data-tab="pending">All Pending</button><button class="tab-button" data-tab="accepted">All Employees</button><button class="tab-button" data-tab="rejected">All Rejected</button></div></div>
                <div id="recent" class="tab-content active"><table class="application-table" id="recentTable"><thead><tr><th>Name</th><th>Role</th><th>Submitted</th><th>Actions</th></tr></thead><tbody></tbody></table><div class="no-apps-message" id="noRecentMessage"></div></div>
                <div id="pending" class="tab-content"><table class="application-table" id="pendingTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Details</th><th>Resume</th><th>Actions</th></tr></thead><tbody></tbody></table><div class="no-apps-message" id="noPendingMessage"></div></div>
                <div id="accepted" class="tab-content"><table class="application-table" id="acceptedTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Details</th><th>Resume</th></tr></thead><tbody></tbody></table><div class="no-apps-message" id="noAcceptedMessage"></div></div>
                <div id="rejected" class="tab-content"><table class="application-table" id="rejectedTable"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Details</th><th>Resume</th></tr></thead><tbody></tbody></table><div class="no-apps-message" id="noRejectedMessage"></div></div>
            </section>
        </div>
        <div id="employees-page" class="main-page">
            <header class="page-header"><div class="greeting"><h1>Employee Directory</h1><p>All active employees and interns, grouped by role.</p></div></header>
            <div class="widget-card">
                 <!-- The container where role sections will be injected -->
                <div id="employeeGrid"></div>
                <div class="no-apps-message" id="noEmployeesMessage"></div>
            </div>
        </div>
       
        <div id="settings-page" class="main-page">
            <header class="page-header"><div class="greeting"><h1>Settings</h1><p>Customize your dashboard experience</p></div></header>
            <div class="widget-card"><div class="settings-section"><h2 class="section-title">Appearance</h2><div class="setting-item"><div class="label"><h4>Dark Mode</h4><p>Switch between light and dark themes.</p></div><label class="toggle-switch"><input type="checkbox" id="darkModeToggle"><span class="slider"></span></label></div><div class="setting-item"><div class="label"><h4>Compact Mode</h4><p>Reduce padding to see more on the screen.</p></div><label class="toggle-switch"><input type="checkbox" id="compactModeToggle"><span class="slider"></span></label></div></div><div class="settings-section"><h2 class="section-title">Notifications</h2><div class="setting-item"><div class="label"><h4>Email Notifications</h4><p>Receive summaries and alerts via email.</p></div><label class="toggle-switch"><input type="checkbox" id="emailNotifyToggle"><span class="slider"></span></label></div><div class="setting-item"><div class="label"><h4>Push Notifications</h4><p>Enable browser push notifications.</p></div><label class="toggle-switch"><input type="checkbox" id="pushNotifyToggle"><span class="slider"></span></label></div></div></div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyDiUI6hSwt9OawThp5cg6quUuofhhVyCRQ",
            authDomain: "lifewoodtmf.firebaseapp.com",
            projectId: "lifewoodtmf",
            storageBucket: "lifewoodtmf.appspot.com",
            messagingSenderId: "125296626344",
            appId: "1:125296626344:web:e26fc1ce7ccf386642509d",
            measurementId: "G-XT2QXSC5PB"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- DOM Elements ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        const compactModeToggle = document.getElementById('compactModeToggle');
        const emailNotifyToggle = document.getElementById('emailNotifyToggle');
        const pushNotifyToggle = document.getElementById('pushNotifyToggle');

        // --- Page Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // ------------------- START: CORRECTED SECURITY CHECK -------------------
            auth.onAuthStateChanged(user => {
                // Check if a user is logged in AND is an admin
                if (user && user.email.endsWith('@lifewood.com')) {
                    // If true, the user is authorized. Load the dashboard.
                    sessionStorage.setItem('isAdminLoggedIn', 'true');
                    initializeDashboard();
                } else {
                    // If false, the user is not authorized.
                    // Sign out any non-admin user and redirect to the home page.
                    auth.signOut();
                    sessionStorage.removeItem('isAdminLoggedIn');
                    window.location.href = 'index.html';
                }
            });
            // ------------------- END: CORRECTED SECURITY CHECK -------------------

        });

        // This function holds all the code to set up the dashboard.
        // It will only be called IF the security check passes.
        function initializeDashboard() {
            initializeSettings();
            setupAllTableListeners();
            displayCurrentDate();

            document.getElementById('logoutBtn').addEventListener('click', () => {
                sessionStorage.removeItem('isAdminLoggedIn');
                auth.signOut(); // This will trigger the onAuthStateChanged listener, which will then redirect.
            });
        }


        // --- Settings Functions (Unchanged) ---
        function showToast(message, type = 'info') { const container = document.getElementById('toast-container'); const toast = document.createElement('div'); toast.className = `toast ${type}`; let iconClass = 'bx-info-circle'; if (type === 'success') iconClass = 'bx-check-circle'; if (type === 'error') iconClass = 'bx-x-circle'; toast.innerHTML = `<i class='bx ${iconClass}'></i><span>${message}</span>`; container.appendChild(toast); setTimeout(() => { toast.remove(); }, 4000); }
        function initializeSettings() { if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); darkModeToggle.checked = true; } if (localStorage.getItem('layout') === 'compact') { document.body.classList.add('compact-mode'); compactModeToggle.checked = true; } emailNotifyToggle.checked = localStorage.getItem('emailNotifications') !== 'false'; if ('Notification' in window) { if (Notification.permission === 'granted') { pushNotifyToggle.checked = true; } else { pushNotifyToggle.checked = false; if (Notification.permission === 'denied') { pushNotifyToggle.disabled = true; } } } else { pushNotifyToggle.disabled = true; } }
        darkModeToggle.addEventListener('change', () => { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', darkModeToggle.checked ? 'dark' : 'light'); });
        compactModeToggle.addEventListener('change', () => { document.body.classList.toggle('compact-mode'); localStorage.setItem('layout', compactModeToggle.checked ? 'compact' : 'default'); showToast(`Compact mode ${compactModeToggle.checked ? 'enabled' : 'disabled'}.`); });
        emailNotifyToggle.addEventListener('change', () => { localStorage.setItem('emailNotifications', emailNotifyToggle.checked); showToast(`Email notifications turned ${emailNotifyToggle.checked ? 'ON' : 'OFF'}.`); });
        pushNotifyToggle.addEventListener('change', async () => { if (!pushNotifyToggle.checked) { showToast('Push notifications turned OFF.', 'error'); return; } if (!('Notification' in window)) { showToast('Push notifications are not supported.', 'error'); pushNotifyToggle.disabled = true; return; } try { const permission = await Notification.requestPermission(); if (permission === 'granted') { showToast('Push notifications enabled!', 'success'); new Notification('Lifewood Admin', { body: 'You will now receive real-time updates!' }); } else if (permission === 'denied') { showToast('Push notifications were blocked.', 'error'); pushNotifyToggle.disabled = true; pushNotifyToggle.checked = false; } else { showToast('Notification permission not granted.'); pushNotifyToggle.checked = false; } } catch (error) { showToast('An error occurred.', 'error'); pushNotifyToggle.checked = false; } });
        
        // --- Page and Tab Navigation (Unchanged) ---
        const navItems = document.querySelectorAll('.sidebar .nav-item');
        const mainPages = document.querySelectorAll('.main-page');
        navItems.forEach(item => {
            if (!item.classList.contains('logout-btn')) {
                item.addEventListener('click', () => {
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const pageId = item.dataset.page + '-page';
                    mainPages.forEach(page => page.classList.toggle('active', page.id === pageId));
                });
            }
        });
        const tabs = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach(content => content.classList.toggle('active', content.id === tab.dataset.tab));
            });
        });

        // --- DATA FETCHING AND DISPLAY (Unchanged) ---
        function setupAllTableListeners() { ['pending', 'accepted', 'rejected'].forEach(status => setupTableListener(status)); }
        function setupTableListener(status) {
            db.collection('applications').where('status', '==', status).orderBy('submittedAt', 'desc')
              .onSnapshot(snapshot => {
                  const countElement = document.getElementById(`${status}Count`);
                  if (countElement) countElement.textContent = snapshot.size;

                  if (status === 'accepted') {
                      populateTable(snapshot, 'acceptedTable', 'noAcceptedMessage');
                      populateEmployeeGrid(snapshot); // MODIFIED: This function now handles the grouping
                  } else if (status === 'pending') {
                      populateTable(snapshot, 'pendingTable', 'noPendingMessage');
                      populateRecentPendingTable(snapshot);
                  } else {
                      populateTable(snapshot, 'rejectedTable', 'noRejectedMessage');
                  }
              }, error => {
                  console.error(`Error fetching '${status}' applications: `, error);
                  showToast(`Error loading data. Check console (F12) for details.`, 'error');
              });
        }
        function populateTable(snapshot, tableId, messageId) {
            const table = document.getElementById(tableId);
            const tableBody = table.querySelector('tbody');
            const noAppsMessage = document.getElementById(messageId);
            tableBody.innerHTML = '';
            if (snapshot.empty) {
                noAppsMessage.textContent = `No applications in this category.`;
                noAppsMessage.style.display = 'block';
                table.style.display = 'none';
                return;
            }
            noAppsMessage.style.display = 'none';
            table.style.display = 'table';
            snapshot.forEach(doc => {
                const app = doc.data();
                const row = tableBody.insertRow();
                const actionsHtml = app.status === 'pending' ? `<td><button class="action-btn accept-btn" data-id="${doc.id}">Accept</button><button class="action-btn reject-btn" data-id="${doc.id}">Reject</button></td>` : '';
                const detailsHtml = `<b>Age:</b> ${app.age||'N/A'}<br><b>Degree:</b> ${app.degree||'N/A'}<br><b>Experience:</b> ${app.experience||'N/A'}`;
                row.innerHTML = `
                    <td>${app.firstName||''} ${app.lastName||''}</td>
                    <td><a href="mailto:${app.email}">${app.email}</a></td>
                    <td>${app.project||'N/A'}</td>
                    <td class="details-cell">${detailsHtml}</td>
                    <td><a href="${app.resumeLink}" target="_blank" rel="noopener noreferrer">View Link</a></td>
                    ${actionsHtml}
                `;
            });
        }
        function populateRecentPendingTable(snapshot) {
            const table = document.getElementById('recentTable');
            const tableBody = table.querySelector('tbody');
            const message = document.getElementById('noRecentMessage');
            tableBody.innerHTML = '';
            const recentDocs = snapshot.docs.slice(0, 5);
            if (recentDocs.length === 0) {
                message.textContent = 'No recent pending applications.';
                message.style.display = 'block';
                table.style.display = 'none';
                return;
            }
            message.style.display = 'none';
            table.style.display = 'table';
            recentDocs.forEach(doc => {
                const app = doc.data();
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${app.firstName||''} ${app.lastName||''}</td>
                    <td>${app.project||'N/A'}</td>
                    <td>${app.submittedAt?.toDate().toLocaleDateString()||'N/A'}</td>
                    <td>
                        <button class="action-btn accept-btn" data-id="${doc.id}">Accept</button>
                        <button class="action-btn reject-btn" data-id="${doc.id}">Reject</button>
                    </td>
                `;
            });
        }
        
        // --- MODIFIED FUNCTION TO GROUP EMPLOYEES BY ROLE ---
        function populateEmployeeGrid(snapshot) {
            const mainContainer = document.getElementById('employeeGrid');
            const message = document.getElementById('noEmployeesMessage');
            mainContainer.innerHTML = ''; // Clear previous content

            if (snapshot.empty) {
                message.textContent = 'No employees found. Accept applications to add them here.';
                message.style.display = 'block';
                mainContainer.style.display = 'none';
                return;
            }

            message.style.display = 'none';
            mainContainer.style.display = 'block';

            // 1. Group employees by their role (project)
            const employeesByRole = {};
            snapshot.forEach(doc => {
                const employee = doc.data();
                const role = employee.project || 'Uncategorized';
                if (!employeesByRole[role]) {
                    employeesByRole[role] = [];
                }
                employeesByRole[role].push(employee);
            });

            // 2. Create HTML for each role group
            const sortedRoles = Object.keys(employeesByRole).sort();

            sortedRoles.forEach(role => {
                // Create a title for the role section
                const roleHeader = document.createElement('h3');
                roleHeader.className = 'role-title';
                roleHeader.textContent = role;
                mainContainer.appendChild(roleHeader);

                // Create a grid container for this specific role
                const roleGrid = document.createElement('div');
                roleGrid.className = 'employee-grid';

                // Create and append employee cards for this role
                employeesByRole[role].forEach(employee => {
                    const card = document.createElement('div');
                    card.className = 'widget-card employee-card';
                    const placeholderImg = `https://i.pravatar.cc/100?u=${employee.email}`;
                    card.innerHTML = `
                        <img src="${placeholderImg}" alt="Profile Picture">
                        <h4>${employee.firstName || ''} ${employee.lastName || ''}</h4>
                        <p>${employee.email || 'N/A'}</p>
                        <span class="status">Active</span>
                    `;
                    roleGrid.appendChild(card);
                });
                
                // Append the role's grid to the main container
                mainContainer.appendChild(roleGrid);
            });
        }
        
        // --- HELPER AND ACTION FUNCTIONS (Unchanged) ---
        function displayCurrentDate() { document.getElementById('currentDate').textContent = `It's ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`; }
        async function handleApplication(appId, newStatus) { try { await db.collection('applications').doc(appId).update({ status: newStatus }); showToast(`Application ${newStatus}.`, 'success'); } catch (error) { console.error("Error updating status:", error); showToast(`Error updating application.`, 'error'); } }
        document.querySelector('.main-content').addEventListener('click', e => {
            if (e.target.classList.contains('accept-btn')) handleApplication(e.target.dataset.id, 'accepted');
            if (e.target.classList.contains('reject-btn')) handleApplication(e.target.dataset.id, 'rejected');
        });
    </script>
</body>
</html>

